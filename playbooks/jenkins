- hosts: jenkins2
  vars:
    jenkins_hostname: localhost
    # jenkins_hostname: jenkins.172.31.24.93.xip.io
    jenkins_admin_password_file: /var/lib/jenkins/secrets/initialAdminPassword
  roles:
    - role: geerlingguy.java
      become: yes
      __java_packages:
        - java-1.8.0-openjdk
    - role: geerlingguy.jenkins
      become: yes

- name: Enable nginx
  hosts: jenkins
  tasks:
    - name: Check to see if nginx repo is enabled
      shell: amazon-linux-extras list | egrep -q 'nginx.* enabled'
      register: nginx_repo_enabled_shell
      failed_when: ( nginx_repo_enabled_shell.rc not in [ 0, 1 ] )
      changed_when: ( nginx_repo_enabled_shell.rc not in [ 0, 1 ] )

    - name: Enable nginx repo from amazon-linux-extras
      shell: "amazon-linux-extras enable nginx1.12"
      become: yes
      when: nginx_repo_enabled_shell.rc != 0

    - name: Make sure that nginx package is installed
      become: yes
      yum:
        name: nginx
        state: latest

    - name: Enable nginx service
      service: name=nginx state=started enabled=true
      become: yes

- name: Configure nginx
  hosts: jenkins
  tasks:
    - name: Set hostname to use
      set_fact: 
        nginx_jenkins_hostname: jenkins.172.31.24.93.xip.io

    # - name: Configure nginx to reverse proxy jenkins part1

    - name: nginx1
      become: yes
      register: nginx1
      template:
        src: templates/jenkins_default_conf.j2
        dest: /etc/nginx/default.d/jenkins.conf
        owner: root
        group: root
        mode: '0644'
        backup: yes

    - name: nginx2
      become: yes
      register: nginx2
      template:
        src: templates/jenkins_conf.j2
        dest: /etc/nginx/conf.d/jenkins.conf
        owner: root
        group: root
        mode: '0644'
        backup: yes

    - name: nginx3
      become: yes
      register: nginx3
      template:
        src: templates/nginx_conf.j2
        dest: /etc/nginx/nginx.conf
        owner: root
        group: root
        mode: '0644'
        backup: yes

    - name: Enable nginx service
      service: name=nginx state=restarted
      become: yes
      when: (nginx1 is defined and nginx1.changed) or
            (nginx2 is defined and nginx2.changed) or
            (nginx3 is defined and nginx3.changed)
